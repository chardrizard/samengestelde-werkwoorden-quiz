<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Werkwoorden Quiz ‚Äî Samengestelde Werkwoorden oefenen</title>
<meta name="description" content="Oefen 160+ meerkeuzevragen over samengestelde werkwoorden en preposities. Gratis quiz op B1+ niveau.">
<meta name="theme-color" content="#0F1117">
<meta name="color-scheme" content="dark">

<!-- Open Graph -->
<meta property="og:title" content="Werkwoorden Quiz ‚Äî Samengestelde Werkwoorden oefenen">
<meta property="og:description" content="Oefen 160+ meerkeuzevragen over samengestelde werkwoorden en preposities. Gratis quiz op B1+ niveau.">
<meta property="og:image" content="og-image.png">
<meta property="og:type" content="website">

<!-- Favicon & Icons -->
<link rel="icon" type="image/png" sizes="32x32" href="assets/icons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="assets/icons/favicon-16x16.png">
<link rel="apple-touch-icon" sizes="180x180" href="assets/icons/apple-touch-icon.png">

<!-- PWA Manifest -->
<link rel="manifest" href="site.webmanifest">

<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--bg:#0F1117;--surface:#181A20;--surface-2:#1E2028;--surface-3:#252830;--ink:#E8E9ED;--ink-2:#A0A3AD;--ink-3:#6B6F7B;--ink-4:#3E414B;--border:rgba(255,255,255,0.06);--border-2:rgba(255,255,255,0.10);--correct:#2D6A4F;--correct-bg:rgba(45,106,79,0.12);--correct-border:rgba(45,106,79,0.4);--wrong:#C44536;--wrong-bg:rgba(196,69,54,0.12);--wrong-border:rgba(196,69,54,0.4);--radius:12px;--radius-lg:16px;--font:'DM Sans',system-ui,sans-serif;--mono:'DM Mono',monospace;--hint-color:rgba(180,190,210,0.85);--hint-bg:rgba(180,190,210,0.06);--hint-border:rgba(180,190,210,0.12);--hint-bg-hover:rgba(180,190,210,0.10);--hint-border-hover:rgba(180,190,210,0.18);--focus-ring:rgba(120,160,255,0.6)}
html{font-size:16px;-webkit-text-size-adjust:100%}
html{height:-webkit-fill-available}
body{font-family:var(--font);background:var(--bg);color:var(--ink);min-height:100vh;min-height:100svh;min-height:-webkit-fill-available;overflow-x:hidden;-webkit-font-smoothing:antialiased}
button{font-family:inherit;cursor:pointer;border:none;background:none;color:inherit}
*:focus{outline:none}
*:focus-visible{outline:2px solid var(--focus-ring);outline-offset:2px;border-radius:var(--radius)}
.option-btn:focus-visible{outline:2px solid var(--focus-ring);outline-offset:2px;box-shadow:0 0 0 4px rgba(120,160,255,0.15)}
.theme-card:focus-visible{outline:2px solid var(--focus-ring);outline-offset:2px;box-shadow:0 0 0 4px rgba(120,160,255,0.15)}
.skip-link{position:absolute;top:-40px;left:0;background:var(--ink);color:var(--bg);padding:8px 16px;z-index:100;font-size:15px;font-weight:600;border-radius:0 0 var(--radius) 0;transition:top 0.2s}
.skip-link:focus{top:0}
.app{max-width:480px;margin:0 auto;min-height:100vh;min-height:100svh;min-height:-webkit-fill-available;display:flex;flex-direction:column;padding:0;transition:max-width 0.2s ease}
.app>main{display:flex;flex-direction:column;flex:1;min-height:0}
.app>main>#app{display:flex;flex-direction:column;flex:1;min-height:0}
.loading{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;color:var(--ink-3);font-size:16px}
.loading-spinner{width:32px;height:32px;border:3px solid var(--surface-3);border-top-color:var(--ink-2);border-radius:50%;animation:spin 0.8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-error{color:var(--wrong);text-align:center;padding:40px 20px;line-height:1.6;flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:16px}
.loading-error button{color:var(--ink);text-decoration:underline;margin-top:12px;font-size:16px}

/* ‚îÄ‚îÄ HOME ‚îÄ‚îÄ */
.home{padding:24px 20px calc(24px + env(safe-area-inset-bottom, 0px));flex:1;display:flex;flex-direction:column}
.home-header{padding:32px 0 24px}
.home-label{font-size:13px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--ink-3);margin-bottom:8px}
.home-title{font-size:34px;font-weight:700;letter-spacing:-0.5px;line-height:1.12;color:var(--ink)}
.home-subtitle{font-size:17px;color:var(--ink-2);margin-top:10px;line-height:1.47}
.theme-grid{display:flex;flex-direction:column;gap:10px;margin-top:24px}
.theme-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:18px 20px;display:flex;align-items:center;gap:16px;transition:all 0.15s ease;position:relative;overflow:hidden}
.theme-card:hover{background:var(--surface-2);border-color:var(--border-2)}
.theme-card:active{transform:scale(0.985)}
.theme-emoji{font-size:28px;width:48px;height:48px;display:flex;align-items:center;justify-content:center;border-radius:10px;flex-shrink:0}
.theme-info{flex:1;min-width:0}
.theme-name{font-size:17px;font-weight:600;letter-spacing:-0.2px}
.theme-desc{font-size:13px;color:var(--ink-3);margin-top:3px;font-family:var(--mono);letter-spacing:-0.3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.theme-badge{font-size:11px;font-weight:600;padding:2px 7px;border-radius:4px;color:var(--ink-2);background:var(--surface-3);margin-top:4px;display:inline-block;letter-spacing:0.3px;font-family:var(--mono)}
.theme-count{font-size:13px;color:var(--ink-3);font-family:var(--mono);flex-shrink:0}
.theme-arrow{color:var(--ink-3);font-size:18px;flex-shrink:0}
.theme-accent{position:absolute;left:0;top:0;bottom:0;width:3px;border-radius:0 3px 3px 0}

/* ‚îÄ‚îÄ COUNT SELECT ‚îÄ‚îÄ */
.count-select{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px 20px;text-align:center}
.count-title{font-size:28px;font-weight:700;margin-bottom:6px;color:var(--ink);letter-spacing:-0.3px}
.count-theme-label{font-size:15px;font-weight:600;margin-bottom:6px;display:inline-flex;align-items:center;gap:6px}
.count-desc{font-size:17px;color:var(--ink-2);margin-bottom:32px}
.count-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;width:100%;max-width:320px}
.count-grid .btn-result.primary{grid-column:span 2}
.count-btn{background:var(--surface);border:1px solid var(--border);padding:20px;border-radius:var(--radius-lg);font-size:22px;font-weight:600;font-family:var(--mono);color:var(--ink);transition:all 0.15s;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:4px}
.count-btn span{font-size:13px;font-weight:400;color:var(--ink-3);font-family:var(--font)}
.count-btn:hover{background:var(--surface-2);border-color:var(--border-2)}
.count-btn:active{transform:scale(0.96)}

/* ‚îÄ‚îÄ QUIZ ‚îÄ‚îÄ */
.quiz{flex:1;display:flex;flex-direction:column;min-height:0;overflow:hidden}
.quiz-top{padding:16px 20px 0;flex-shrink:0}
.quiz-nav{display:flex;align-items:center;gap:12px;margin-bottom:16px}
.quiz-back{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;background:var(--surface);border:1px solid var(--border);font-size:17px;transition:all 0.15s}
.quiz-back:hover{background:var(--surface-2)}
.quiz-theme{font-size:15px;font-weight:600;flex:1}
.quiz-counter{font-family:var(--mono);font-size:14px;color:var(--ink-2)}
.progress-wrap{display:flex;align-items:center;gap:10px;margin-bottom:4px}
.progress-bar{flex:1;height:4px;background:var(--surface-3);border-radius:2px;overflow:hidden}
.progress-fill{height:100%;border-radius:2px;transition:width 0.4s cubic-bezier(0.4,0,0.2,1)}
.score-pills{display:flex;gap:8px}
.score-pill{display:flex;align-items:center;gap:4px;font-size:13px;font-weight:600;font-family:var(--mono);padding:3px 8px;border-radius:6px}
.score-pill.correct{background:var(--correct-bg);color:#52B788}
.score-pill.wrong{background:var(--wrong-bg);color:#E8776C}
.score-pill .dot{width:6px;height:6px;border-radius:50%}
.score-pill.correct .dot{background:#52B788}
.score-pill.wrong .dot{background:#E8776C}
.quiz-body{flex:1;padding:20px;display:flex;flex-direction:column;overflow-y:auto;-webkit-overflow-scrolling:touch;min-height:0}
.question-num{font-size:13px;font-weight:600;color:var(--ink-3);font-family:var(--mono);margin-bottom:12px}
.question-text{font-size:22px;font-weight:500;line-height:1.45;letter-spacing:-0.2px;margin-bottom:28px;min-height:60px}
.options{display:flex;flex-direction:column;gap:8px}
.option-btn{width:100%;text-align:left;padding:15px 16px;border-radius:var(--radius);background:var(--surface);border:1.5px solid var(--border);font-size:17px;font-weight:400;line-height:1.4;display:flex;align-items:flex-start;gap:12px;transition:all 0.15s ease;position:relative}
.option-btn:not(.answered):hover{background:var(--surface-2);border-color:var(--border-2)}
.option-btn:not(.answered):active{transform:scale(0.99)}
.option-key{width:26px;height:26px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:600;font-family:var(--mono);flex-shrink:0;background:var(--surface-3);color:var(--ink-2)}
.option-text{padding-top:2px}
.option-btn.answered{pointer-events:none}
.option-btn.is-correct{background:var(--correct-bg);border-color:var(--correct-border)}
.option-btn.is-correct .option-key{background:var(--correct);color:#fff}
.option-btn.is-wrong{background:var(--wrong-bg);border-color:var(--wrong-border)}
.option-btn.is-wrong .option-key{background:var(--wrong);color:#fff}
.option-btn.is-actual-correct{background:var(--correct-bg);border-color:var(--correct-border)}
.option-btn.is-actual-correct .option-key{background:var(--correct);color:#fff}

/* ‚îÄ‚îÄ FILL-IN INPUT ‚îÄ‚îÄ */
.fill-input-wrap{display:flex;gap:10px;align-items:stretch}
.fill-input{flex:1;padding:14px 16px;border-radius:var(--radius);background:var(--surface);border:1.5px solid var(--border-2);font-size:20px;font-weight:500;font-family:var(--mono);color:var(--ink);letter-spacing:0.5px;transition:all 0.15s;caret-color:var(--ink)}
.fill-input::placeholder{color:var(--ink-4);font-weight:400;letter-spacing:0}
.fill-input:focus{border-color:rgba(120,160,255,0.5);background:var(--surface-2);outline:none}
.fill-input:disabled{opacity:0.5;cursor:not-allowed}
.fill-input.is-correct{border-color:var(--correct-border);background:var(--correct-bg);color:#52B788}
.fill-input.is-wrong{border-color:var(--wrong-border);background:var(--wrong-bg);color:#E8776C}
.fill-submit{padding:14px 20px;border-radius:var(--radius);background:var(--ink);color:var(--bg);font-size:16px;font-weight:600;transition:all 0.15s;flex-shrink:0;letter-spacing:-0.2px}
.fill-submit:hover{opacity:0.9}
.fill-submit:active{transform:scale(0.97)}
.fill-submit:disabled{background:var(--surface-3);color:var(--ink-4);pointer-events:none}
.fill-correct-answer{margin-top:10px;font-size:15px;font-family:var(--mono);color:#52B788;font-weight:600;animation:feedbackIn 0.25s ease}
.fill-your-answer{color:#E8776C;font-family:var(--mono);font-weight:500}

/* ‚îÄ‚îÄ FEEDBACK ‚îÄ‚îÄ */
.feedback{margin-top:16px;padding:14px 16px;border-radius:var(--radius);font-size:15px;line-height:1.6;animation:feedbackIn 0.25s ease}
@keyframes feedbackIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.feedback.correct{background:var(--correct-bg);border:1px solid var(--correct-border)}
.feedback.wrong{background:var(--wrong-bg);border:1px solid var(--wrong-border)}
.feedback-label{font-weight:600;margin-bottom:4px;display:flex;align-items:center;gap:6px;font-size:16px}
.feedback.correct .feedback-label{color:#52B788}
.feedback.wrong .feedback-label{color:#E8776C}
.feedback-text{color:var(--ink-2)}

/* ‚îÄ‚îÄ HINT (footer-anchored popover) ‚îÄ‚îÄ */
.hint-btn{display:inline-flex;align-items:center;gap:6px;padding:7px 13px 7px 10px;border-radius:8px;background:var(--hint-bg);border:1px solid var(--hint-border);font-size:14px;font-weight:500;color:var(--ink-3);transition:all 0.18s ease;line-height:1;flex-shrink:0}
.hint-btn:hover{background:var(--hint-bg-hover);border-color:var(--hint-border-hover);color:var(--hint-color)}
.hint-btn.open{background:var(--hint-bg-hover);border-color:var(--hint-border-hover);color:var(--hint-color)}
.hint-btn .hint-icon{font-size:14px;line-height:1;display:flex;align-items:center}
.hint-btn .hint-chevron{font-size:9px;margin-left:2px;opacity:0.5;transition:transform 0.2s ease;display:inline-block}
.hint-btn.open .hint-chevron{transform:rotate(180deg)}
.hint-popover-wrap{position:relative}
.hint-popover{position:absolute;bottom:calc(100% + 10px);left:0;right:0;padding:14px 16px;border-radius:var(--radius);background:var(--surface-3);border:1px solid var(--border-2);font-size:15px;color:var(--ink-2);line-height:1.6;box-shadow:0 8px 32px rgba(0,0,0,0.5);animation:hintPopIn 0.2s ease;z-index:10}
@keyframes hintPopIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.hint-popover::after{content:'';position:absolute;bottom:-5px;left:20px;width:10px;height:10px;background:var(--surface-3);border-right:1px solid var(--border-2);border-bottom:1px solid var(--border-2);transform:rotate(45deg)}
.hint-popover .hint-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.hint-popover .hint-label{font-size:12px;font-weight:600;color:var(--ink-3);font-family:var(--mono);letter-spacing:0.3px;display:flex;align-items:center;gap:5px}
.hint-close{width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:16px;color:var(--ink-2);background:var(--surface);border:1px solid var(--border);cursor:pointer;transition:all 0.15s;flex-shrink:0}
.hint-close:hover{background:var(--surface-2);border-color:var(--border-2);color:var(--ink)}
.hint-overlay{position:fixed;inset:0;z-index:9}

/* ‚îÄ‚îÄ QUIZ FOOTER ‚îÄ‚îÄ */
.quiz-footer{padding:16px 20px calc(24px + env(safe-area-inset-bottom, 0px));flex-shrink:0;display:flex;flex-direction:column;gap:10px;background:var(--bg);position:relative;z-index:8}
.quiz-footer-row{display:flex;gap:8px;align-items:center}
.btn-next{width:100%;padding:15px;border-radius:var(--radius);font-size:17px;font-weight:600;text-align:center;transition:all 0.15s ease;letter-spacing:-0.2px;flex:1}
.btn-next.primary{background:var(--ink);color:var(--bg)}
.btn-next.primary:hover{opacity:0.9}
.btn-next.primary:active{transform:scale(0.98)}
.btn-next.disabled{background:var(--surface-3);color:var(--ink-3);pointer-events:none}

/* ‚îÄ‚îÄ RESULTS ‚îÄ‚îÄ */
.results{padding:24px 20px calc(24px + env(safe-area-inset-bottom, 0px));flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center}
.results-emoji{font-size:64px;margin-bottom:20px;animation:pop 0.4s cubic-bezier(0.34,1.56,0.64,1)}
@keyframes pop{from{transform:scale(0)}to{transform:scale(1)}}
.results-score{font-size:56px;font-weight:700;letter-spacing:-2px;font-family:var(--mono)}
.results-label{font-size:17px;color:var(--ink-2);margin-top:4px}
.results-msg{font-size:17px;color:var(--ink-2);margin-top:16px;line-height:1.5;max-width:300px}
.results-stats{display:flex;gap:24px;margin-top:32px}
.stat{text-align:center}
.stat-val{font-size:28px;font-weight:700;font-family:var(--mono)}
.stat-val.g{color:#52B788}.stat-val.r{color:#E8776C}
.stat-label{font-size:13px;color:var(--ink-3);margin-top:4px}
.results-actions{display:flex;flex-direction:column;gap:10px;width:100%;max-width:300px;margin-top:36px}
.btn-result{padding:15px;border-radius:var(--radius);font-size:17px;font-weight:600;text-align:center;transition:all 0.15s;letter-spacing:-0.2px}
.btn-result.primary{background:var(--ink);color:var(--bg)}
.btn-result.secondary{background:var(--surface);color:var(--ink);border:1px solid var(--border)}
.btn-result:hover{opacity:0.9}
.btn-result:active{transform:scale(0.98)}
.btn-result.link{background:none;border:none;color:var(--ink-3);font-size:15px;font-weight:500}
.btn-result.link:hover{color:var(--ink-2)}

/* ‚îÄ‚îÄ REVIEW ‚îÄ‚îÄ */
.review{padding:20px 20px calc(20px + env(safe-area-inset-bottom, 0px));flex:1}
.review-header{display:flex;align-items:center;gap:12px;margin-bottom:20px}
.review-title{font-size:20px;font-weight:600}
.review-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:16px;margin-bottom:10px}
.review-q{font-size:16px;line-height:1.5;margin-bottom:8px}
.review-answer{font-size:15px;color:var(--ink-2);line-height:1.5}
.review-answer strong{color:#52B788;font-weight:600}
.review-answer .wrong-text{color:#E8776C}

/* ‚îÄ‚îÄ KEYBOARD HINTS ‚îÄ‚îÄ */
.kbd-hints{display:none;gap:6px;flex-wrap:wrap;margin-top:16px;justify-content:center}
.quiz-footer .kbd-hints{margin-top:0}
.kbd-hint{display:inline-flex;align-items:center;gap:5px;font-size:12px;color:var(--ink-3);font-family:var(--mono)}
.kbd{display:inline-flex;align-items:center;justify-content:center;min-width:22px;height:20px;padding:0 5px;border-radius:4px;background:var(--surface-3);border:1px solid var(--ink-4);font-size:11px;font-weight:600;color:var(--ink-2);font-family:var(--mono);line-height:1}
.hint-kbd{display:none}
@media(hover:hover) and (pointer:fine){
  .kbd-hints{display:flex}
  .hint-kbd{display:inline-flex}
}
@media(pointer:coarse){
  .kbd-hints{display:none !important}
  .hint-kbd{display:none !important}
  .option-btn{padding:10px 14px;gap:10px;font-size:16px}
  .option-key{width:24px;height:24px;font-size:12px;border-radius:5px}
  .options{gap:6px}
  .question-text{font-size:20px;margin-bottom:20px;min-height:auto}
  .question-num{margin-bottom:8px}
}

@media(min-width:768px){.app{max-width:50vw}}
@media(min-width:1400px){.app{max-width:640px}}
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
</style>
</head>
<body>
<a class="skip-link" href="#main-content">Ga naar inhoud</a>
<div class="app">
  <main id="main-content">
    <div id="app" role="application">
      <div class="loading"><div class="loading-spinner"></div><div>Vragen laden...</div></div>
    </div>
  </main>
</div>
<noscript>
  <div style="padding:40px 20px;text-align:center;color:#A0A3AD;font-family:system-ui,sans-serif;">
    <p style="font-size:18px;margin-bottom:8px;">JavaScript is vereist</p>
    <p>Schakel JavaScript in om de Werkwoorden Quiz te gebruiken.</p>
  </div>
</noscript>
<div id="sr-announce" class="sr-only" aria-live="polite" aria-atomic="true"></div>
<script>
// ‚îÄ‚îÄ XSS sanitization ‚îÄ‚îÄ
function esc(str){
  if(typeof str!=="string")return str;
  var d=document.createElement("div");
  d.appendChild(document.createTextNode(str));
  return d.innerHTML;
}

const KEYS=["A","B","C","D"];
const KEY_MAP={a:0,b:1,c:2,d:3,"1":0,"2":1,"3":2,"4":3};
let THEMES=[];
const MIX_THEME = {id: "mix", label: "Alles door elkaar", description: "Test je kennis van alle thema's", emoji: "üé≤", color: "#E09F3E"};
let questionCache={};
let shuffledQuestions=[];
let state={screen:"loading",theme:null,qIdx:0,score:0,wrong:0,answered:null,selectedIdx:null,showHint:false,wrongAnswers:[],showReview:false,pendingTheme:null,fillInput:""};
let pendingFocus=null;

function announce(text){const el=document.getElementById("sr-announce");if(el){el.textContent="";requestAnimationFrame(()=>{el.textContent=text})}}

function getQuizType(themeId){
  if(themeId==="mix")return "mc";
  var t=THEMES.find(function(x){return x.id===themeId});
  return (t&&t.type)?t.type:"mc";
}

function getCurrentQuizType(){
  // For mix mode, check the individual question
  if(state.theme==="mix"){
    // Mix only includes MC themes for now
    return "mc";
  }
  return getQuizType(state.theme);
}

async function loadThemes(){try{const res=await fetch("data/themes.json");if(!res.ok)throw new Error("HTTP "+res.status);THEMES=await res.json();console.log("Loaded "+THEMES.length+" themes");state.screen="home";render()}catch(err){console.error("Failed to load themes:",err);document.getElementById("app").innerHTML='<div class="loading-error"><p>Kon de thema\'s niet laden.</p><p style="font-size:14px;color:var(--ink-3)">'+esc(err.message)+'</p><button onclick="loadThemes()">Opnieuw proberen</button></div>'}}
async function loadThemeQuestions(themeId){if(questionCache[themeId])return questionCache[themeId];const res=await fetch("data/"+encodeURIComponent(themeId)+".json");if(!res.ok)throw new Error("HTTP "+res.status);const questions=await res.json();questionCache[themeId]=questions;return questions}
function shuffle(a){const b=[...a];for(let i=b.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[b[i],b[j]]=[b[j],b[i]]}return b}

// ‚îÄ‚îÄ Count selection for individual themes ‚îÄ‚îÄ
function openThemeCountSelect(themeId) {
  state.screen = "count-select";
  state.pendingTheme = themeId;
  pendingFocus = "count-10";
  render();
  var t = THEMES.find(function(x){return x.id===themeId});
  announce("Kies het aantal vragen voor " + (t ? t.label : themeId) + ".");
}

async function startThemeQuiz(themeId, count) {
  state={screen:"loading",theme:themeId,qIdx:0,score:0,wrong:0,answered:null,selectedIdx:null,showHint:false,wrongAnswers:[],showReview:false,pendingTheme:null,fillInput:""};
  render();
  try {
    const questions = await loadThemeQuestions(themeId);
    shuffledQuestions = shuffle(questions);
    if (count !== 'all') {
      shuffledQuestions = shuffledQuestions.slice(0, count);
    }
    state.screen = "quiz";
    pendingFocus = getQuizType(themeId)==="fill" ? "fill-input" : "option-0";
    render();
    announce("Quiz gestart. Vraag 1 van " + shuffledQuestions.length + ".");
  } catch(err) {
    console.error("Failed to load questions:", themeId, err);
    document.getElementById("app").innerHTML='<div class="loading-error"><p>Kon de vragen niet laden.</p><button onclick="openThemeCountSelect(\''+esc(themeId)+'\')">Opnieuw proberen</button></div>';
  }
}

async function startQuiz(id) {
  openThemeCountSelect(id);
}

function openCountSelect() {
  state.screen = "count-select";
  state.pendingTheme = "mix";
  pendingFocus = "count-10";
  render();
  announce("Kies het aantal vragen: 10, 20 of 50.");
}

async function startMixQuiz(count) {
  state={screen:"loading",theme:"mix",qIdx:0,score:0,wrong:0,answered:null,selectedIdx:null,showHint:false,wrongAnswers:[],showReview:false,pendingTheme:null,fillInput:""};
  render();
  try {
    // Only include MC themes in mix mode
    const mcThemes = THEMES.filter(function(t){return (t.type||"mc")==="mc"});
    const promises = mcThemes.map(t => loadThemeQuestions(t.id));
    const results = await Promise.all(promises);
    let allQuestions = results.flat();
    shuffledQuestions = shuffle(allQuestions);
    if(count !== 'all') {
      shuffledQuestions = shuffledQuestions.slice(0, count);
    }
    state.screen = "quiz";
    pendingFocus = "option-0";
    render();
    announce("Mix quiz gestart met " + shuffledQuestions.length + " vragen.");
  } catch (err) {
    console.error("Failed to start mix quiz:", err);
    document.getElementById("app").innerHTML='<div class="loading-error"><p>Kon de mix quiz niet laden.</p><button onclick="loadThemes()">Terug naar home</button></div>';
  }
}

function goHome(){state={screen:"home",theme:null,qIdx:0,score:0,wrong:0,answered:null,selectedIdx:null,showHint:false,wrongAnswers:[],showReview:false,pendingTheme:null,fillInput:""};pendingFocus="theme-0";render();}

function selectAnswer(idx){if(state.answered!==null)return;const q=shuffledQuestions[state.qIdx],isC=idx===q.correct;state.answered=isC?"correct":"wrong";state.selectedIdx=idx;if(isC){state.score++;announce("Goed! "+q.explanation)}else{state.wrong++;state.wrongAnswers.push({q:q.sentence,selected:q.options[idx],correct:q.options[q.correct],explanation:q.explanation});announce("Fout. "+q.options[q.correct])}pendingFocus="btn-next";render()}

function submitFillAnswer(){
  if(state.answered!==null)return;
  var q=shuffledQuestions[state.qIdx];
  var input=(state.fillInput||"").trim().toLowerCase();
  if(!input)return;
  var isCorrect=q.acceptedAnswers.some(function(a){return a.toLowerCase()===input});
  state.answered=isCorrect?"correct":"wrong";
  state.selectedIdx=input;
  if(isCorrect){
    state.score++;
    announce("Goed! "+q.explanation);
  }else{
    state.wrong++;
    state.wrongAnswers.push({q:q.sentence,selected:input,correct:q.answer,explanation:q.explanation});
    announce("Fout. Het juiste antwoord is: "+q.answer);
  }
  pendingFocus="btn-next";
  render();
}

function nextQuestion(){if(state.qIdx>=shuffledQuestions.length-1){state.screen="results";pendingFocus="btn-retry";render();announce("Quiz afgelopen. Score: "+Math.round(state.score/shuffledQuestions.length*100)+"%");return}state.qIdx++;state.answered=null;state.selectedIdx=null;state.showHint=false;state.fillInput="";var type=getCurrentQuizType();pendingFocus=type==="fill"?"fill-input":"option-0";render();announce("Vraag "+(state.qIdx+1))}
function toggleHint(){state.showHint=!state.showHint;pendingFocus=state.showHint?"hint-close-btn":"hint-btn";render();if(state.showHint)announce("Hint: "+shuffledQuestions[state.qIdx].hint)}
function toggleReview(){state.showReview=!state.showReview;pendingFocus=state.showReview?"review-back":"btn-review";render()}
function getThemeQuestionCount(themeId){if(questionCache[themeId])return questionCache[themeId].length;return "~40"}

function render(){const app=document.getElementById("app");switch(state.screen){case"loading":app.innerHTML='<div class="loading"><div class="loading-spinner"></div><div>Vragen laden...</div></div>';break;case"home":app.innerHTML=renderHome();break;case"count-select":app.innerHTML=renderCountSelect();break;case"quiz":app.innerHTML=renderQuiz();break;case"results":app.innerHTML=state.showReview?renderReview():renderResults();break;}if(pendingFocus){requestAnimationFrame(()=>{const el=document.getElementById(pendingFocus);if(el){el.focus();// Restore fill input value after render
if(pendingFocus==="fill-input"&&state.fillInput){el.value=state.fillInput}}pendingFocus=null})}}

function renderHome(){
  const themeCards = THEMES.map(function(t,idx){
    var c=getThemeQuestionCount(t.id);
    var badge=(t.type==="fill")?'<div class="theme-badge">INVULLEN</div>':"";
    return '<button class="theme-card" id="theme-'+idx+'" onclick="openThemeCountSelect(\''+esc(t.id)+'\')" aria-label="'+esc(t.label)+'"><div class="theme-accent" style="background:'+esc(t.color)+'"></div><div class="theme-emoji" style="background:'+esc(t.color)+'15">'+esc(t.emoji)+'</div><div class="theme-info"><div class="theme-name">'+esc(t.label)+'</div><div class="theme-desc">'+esc(t.description)+'</div>'+badge+'</div><div class="theme-count">'+esc(String(c))+'</div><div class="theme-arrow">‚Ä∫</div></button>';
  }).join("");
  const mixCard = '<button class="theme-card" id="theme-mix" onclick="openCountSelect()" aria-label="Alles door elkaar"><div class="theme-accent" style="background:'+MIX_THEME.color+'"></div><div class="theme-emoji" style="background:'+MIX_THEME.color+'15">'+MIX_THEME.emoji+'</div><div class="theme-info"><div class="theme-name">'+MIX_THEME.label+'</div><div class="theme-desc">'+MIX_THEME.description+'</div></div><div class="theme-count">Mix</div><div class="theme-arrow">‚Ä∫</div></button>';
  return '<div class="home"><div class="home-header"><div class="home-label">Oefening</div><div class="home-title">Samengestelde Werkwoorden</div><div class="home-subtitle">Kies een thema en oefen met meerkeuzevragen op B1+ niveau.</div></div><nav class="theme-grid" aria-label="Themakeuze">'+themeCards+mixCard+'</nav><div class="kbd-hints"><span class="kbd-hint"><span class="kbd">Tab</span> navigeren</span><span class="kbd-hint"><span class="kbd">Enter</span> selecteren</span></div></div>';
}

function renderCountSelect() {
  var isMix = (state.pendingTheme === "mix");
  var t = isMix ? MIX_THEME : THEMES.find(function(x){return x.id===state.pendingTheme});
  var themeLabel = t ? (t.emoji + " " + t.label) : "";
  var totalCount = isMix ? "160+" : getThemeQuestionCount(state.pendingTheme);
  var safeThemeId = esc(state.pendingTheme);
  var isFill = !isMix && t && t.type === "fill";
  var desc = isFill ? "Vul het juiste voorzetsel in bij elke zin." : (isMix ? "Kies een aantal vragen uit alle thema's." : "Kies hoeveel vragen je wilt oefenen.");

  var buttons = '';
  buttons += '<button class="count-btn" id="count-10" onclick="'+(isMix?"startMixQuiz(10)":"startThemeQuiz('"+safeThemeId+"',10)")+'">10<span>vragen</span></button>';
  buttons += '<button class="count-btn" onclick="'+(isMix?"startMixQuiz(20)":"startThemeQuiz('"+safeThemeId+"',20)")+'">20<span>vragen</span></button>';

  if (isMix) {
    buttons += '<button class="count-btn" onclick="startMixQuiz(50)" style="grid-column:span 2">50<span>vragen</span></button>';
  } else {
    buttons += '<button class="count-btn" onclick="startThemeQuiz(\''+safeThemeId+'\',\'all\')" style="grid-column:span 2">'+esc(String(totalCount))+'<span>alle vragen</span></button>';
  }

  return '<div class="count-select"><div class="count-theme-label" style="color:'+esc(t.color)+'">'+esc(themeLabel)+'</div><div class="count-title">Hoeveel vragen?</div><div class="count-desc">'+desc+'</div><div class="count-grid">'+buttons+'</div><button class="quiz-back" onclick="goHome()" style="margin-top:32px;width:auto;padding:0 20px;height:44px;gap:8px;font-size:15px">‚Üê Terug</button></div>';
}

function renderQuiz(){
  var quizType=getCurrentQuizType();
  var t = (state.theme === "mix") ? MIX_THEME : THEMES.find(function(x){return x.id===state.theme});
  var q=shuffledQuestions[state.qIdx],total=shuffledQuestions.length,pct=((state.qIdx+(state.answered?1:0))/total*100).toFixed(1);

  // Build question area based on type
  var questionArea="";
  if(quizType==="fill"){
    questionArea=renderFillQuestion(q,t);
  }else{
    questionArea=renderMCQuestion(q,t);
  }

  // Feedback
  var fb="";
  if(state.answered){
    var isC=state.answered==="correct";
    var label=isC?"‚úì Goed!":"‚úó Niet helemaal";
    var text="";
    if(quizType==="fill"){
      text=esc(q.explanation);
      if(!isC){
        text='<span class="fill-your-answer">Jouw antwoord: '+esc(String(state.selectedIdx))+'</span><br><br>'+text;
      }
    }else{
      text=isC?esc(q.explanation):(esc(q.wrongExplanations[state.selectedIdx]||"")+"<br><br>"+esc(q.explanation));
    }
    fb='<div class="feedback '+state.answered+'" role="alert"><div class="feedback-label">'+label+'</div><div class="feedback-text">'+text+'</div></div>';
  }

  // Correct answer display for fill-in after wrong
  var correctDisplay="";
  if(quizType==="fill"&&state.answered==="wrong"){
    var allAnswers=q.acceptedAnswers.join(" / ");
    correctDisplay='<div class="fill-correct-answer">Juiste antwoord: '+esc(allAnswers)+'</div>';
  }

  // Keyboard hints
  var kbdBar="";
  if(quizType==="fill"){
    kbdBar='<div class="kbd-hints"><span class="kbd-hint"><span class="kbd">Enter</span> controleer / volgende</span><span class="kbd-hint"><span class="kbd">H</span> hint</span><span class="kbd-hint"><span class="kbd">Esc</span> terug</span></div>';
  }else{
    kbdBar='<div class="kbd-hints"><span class="kbd-hint"><span class="kbd">A</span><span class="kbd">B</span><span class="kbd">C</span><span class="kbd">D</span> kies</span><span class="kbd-hint"><span class="kbd">H</span> hint</span><span class="kbd-hint"><span class="kbd">Enter</span> volgende</span><span class="kbd-hint"><span class="kbd">Esc</span> terug</span></div>';
  }

  // Hint popover
  var hintPopover="";
  if(!state.answered){
    var popoverContent="";
    if(state.showHint){popoverContent='<div class="hint-overlay" onclick="toggleHint()"></div><div class="hint-popover" id="hint-box" role="region" aria-label="Hint"><div class="hint-header"><div class="hint-label"><span>üí°</span> Hint</div><button class="hint-close" onclick="toggleHint()" aria-label="Hint sluiten" id="hint-close-btn">‚úï</button></div>'+esc(q.hint)+'</div>'}
    hintPopover='<div class="hint-popover-wrap">'+popoverContent+'<button class="hint-btn'+(state.showHint?" open":"")+'" id="hint-btn" onclick="toggleHint()" aria-expanded="'+(state.showHint?"true":"false")+'" aria-controls="hint-box"><span class="hint-icon">üí°</span><span>Hint</span><span class="kbd hint-kbd" style="margin-left:4px">H</span><span class="hint-chevron">‚ñæ</span></button></div>';
  }

  // Footer
  var footerRow='<div class="quiz-footer-row">'+hintPopover+'<button class="btn-next '+(state.answered?"primary":"disabled")+'" id="btn-next" onclick="nextQuestion()"'+(state.answered?'':' tabindex="-1" aria-disabled="true"')+'>'+(state.qIdx>=total-1&&state.answered?"Resultaten bekijken":"Volgende ‚Üí")+'</button></div>';

  return '<div class="quiz"><div class="quiz-top"><div class="quiz-nav"><button class="quiz-back" onclick="goHome()" aria-label="Terug naar thema\'s (Escape)">‚Üê</button><div class="quiz-theme" style="color:'+esc(t.color)+'">'+esc(t.emoji)+" "+esc(t.label)+'</div><div class="quiz-counter" aria-label="Voortgang">'+(state.qIdx+1)+" / "+total+'</div></div><div class="progress-wrap"><div class="progress-bar" role="progressbar" aria-valuenow="'+pct+'" aria-valuemin="0" aria-valuemax="100"><div class="progress-fill" style="width:'+pct+"%;background:"+esc(t.color)+'"></div></div><div class="score-pills" aria-label="Score"><div class="score-pill correct" aria-label="'+state.score+' goed"><span class="dot"></span>'+state.score+'</div><div class="score-pill wrong" aria-label="'+state.wrong+' fout"><span class="dot"></span>'+state.wrong+'</div></div></div></div><div class="quiz-body"><div class="question-num">'+esc(t.label)+" ¬∑ Vraag "+(state.qIdx+1)+'</div><div class="question-text" id="question-text">'+esc(q.sentence)+'</div>'+questionArea+correctDisplay+fb+'</div><div class="quiz-footer">'+kbdBar+footerRow+"</div></div>";
}

function renderFillQuestion(q,t){
  var inputCls="fill-input";
  var inputDisabled="";
  var btnDisabled="";
  if(state.answered){
    inputCls+=" "+(state.answered==="correct"?"is-correct":"is-wrong");
    inputDisabled=' disabled';
    btnDisabled=' disabled';
  }
  var inputVal=state.answered?esc(String(state.selectedIdx)):'';
  return '<div class="fill-input-wrap"><input type="text" class="'+inputCls+'" id="fill-input" placeholder="Typ het voorzetsel..." autocomplete="off" autocapitalize="none" spellcheck="false" value="'+inputVal+'"'+inputDisabled+' oninput="state.fillInput=this.value"><button class="fill-submit" id="fill-submit" onclick="submitFillAnswer()"'+btnDisabled+'>Check</button></div>';
}

function renderMCQuestion(q,t){
  return '<div class="options" role="group" aria-labelledby="question-text">'+q.options.map(function(opt,i){var cls="option-btn";var ariaLabel=KEYS[i]+": "+esc(opt);if(state.answered){cls+=" answered";if(i===q.correct){cls+=" is-correct is-actual-correct";ariaLabel+=" (juist antwoord)"}else if(i===state.selectedIdx&&state.answered==="wrong"){cls+=" is-wrong";ariaLabel+=" (jouw foute antwoord)"}}return '<button class="'+cls+'" id="option-'+i+'" onclick="selectAnswer('+i+')" aria-label="'+ariaLabel+'"'+(state.answered?' tabindex="-1"':'')+'><span class="option-key">'+KEYS[i]+'</span><span class="option-text">'+esc(opt)+"</span></button>"}).join("")+"</div>";
}

function renderResults(){var total=shuffledQuestions.length,pct=Math.round(state.score/total*100),emoji="üéâ",msg="Uitstekend! Je beheerst deze werkwoorden goed.";if(pct<50){emoji="üìö";msg="Blijf oefenen! Herhaling is de sleutel tot succes."}else if(pct<70){emoji="üí™";msg="Goed bezig! Nog een paar rondes en je hebt het onder de knie."}else if(pct<90){emoji="üåü";msg="Heel goed! Je bent er bijna."}var t = (state.theme === "mix") ? MIX_THEME : THEMES.find(function(x){return x.id===state.theme});var retryAction = (state.theme === "mix") ? "openCountSelect()" : "openThemeCountSelect('"+esc(state.theme)+"')";return '<div class="results"><div class="results-emoji">'+emoji+'</div><div class="results-score" style="color:'+esc(t.color)+'">'+pct+'%</div><div class="results-label">'+state.score+" van "+total+' goed</div><div class="results-msg">'+msg+'</div><div class="results-stats"><div class="stat"><div class="stat-val g">'+state.score+'</div><div class="stat-label">Goed</div></div><div class="stat"><div class="stat-val r">'+state.wrong+'</div><div class="stat-label">Fout</div></div><div class="stat"><div class="stat-val" style="color:'+esc(t.color)+'">'+total+'</div><div class="stat-label">Totaal</div></div></div><div class="results-actions"><button class="btn-result primary" id="btn-retry" onclick="'+retryAction+'">Opnieuw proberen</button>'+(state.wrong>0?'<button class="btn-result secondary" id="btn-review" onclick="toggleReview()">Foute antwoorden bekijken ('+state.wrong+")</button>":"")+'<button class="btn-result link" onclick="goHome()">‚Üê Terug naar thema\'s</button></div><div class="kbd-hints"><span class="kbd-hint"><span class="kbd">Enter</span> opnieuw</span><span class="kbd-hint"><span class="kbd">Esc</span> terug</span></div></div>'}

function renderReview(){var retryAction = (state.theme === "mix") ? "openCountSelect()" : "openThemeCountSelect('"+esc(state.theme)+"')";return '<div class="review"><div class="review-header"><button class="quiz-back" id="review-back" onclick="toggleReview()" aria-label="Terug naar resultaten (Escape)">‚Üê</button><div class="review-title">Foute antwoorden ('+state.wrongAnswers.length+')</div></div>'+state.wrongAnswers.map(function(w,i){return '<div class="review-card"><div class="review-q">'+(i+1)+". "+esc(w.q)+'</div><div class="review-answer"><span class="wrong-text">Jouw antwoord: '+esc(w.selected)+"</span><br><strong>Correct: "+esc(w.correct)+"</strong><br>"+esc(w.explanation)+"</div></div>"}).join("")+'<div style="padding:16px 0"><button class="btn-result primary" onclick="'+retryAction+'" style="width:100%">Opnieuw proberen</button></div></div>'}

document.addEventListener("keydown",function(e){
  if(e.target.tagName==="TEXTAREA")return;
  var key=e.key.toLowerCase();

  // Special handling for fill-in input
  if(e.target.id==="fill-input"){
    if(key==="enter"){
      e.preventDefault();
      if(state.answered===null){
        submitFillAnswer();
      }else{
        nextQuestion();
      }
      return;
    }
    if(key==="escape"){
      e.preventDefault();
      if(state.showHint){toggleHint()}else{goHome()}
      return;
    }
    if(key==="h"&&e.ctrlKey&&state.answered===null){
      e.preventDefault();
      toggleHint();
      return;
    }
    return; // Let other keys type normally
  }

  if(state.screen==="quiz"){
    var quizType=getCurrentQuizType();
    if(quizType==="mc"&&key in KEY_MAP&&state.answered===null){e.preventDefault();selectAnswer(KEY_MAP[key]);return}
    if((key==="enter"||key===" ")&&state.answered!==null){var active=document.activeElement;if(!active||active===document.body||active.classList.contains("btn-next")){e.preventDefault();nextQuestion();return}}
    if(key==="h"&&state.answered===null){e.preventDefault();toggleHint();return}
    if(key==="escape"){e.preventDefault();if(state.showHint){toggleHint()}else{goHome()}return}
    if(quizType==="mc"&&(key==="arrowdown"||key==="arrowup")&&state.answered===null){e.preventDefault();var opts=document.querySelectorAll(".option-btn:not(.answered)");if(opts.length===0)return;var currentIdx=-1;opts.forEach(function(o,i){if(o===document.activeElement)currentIdx=i});if(key==="arrowdown"){currentIdx=(currentIdx+1)%opts.length}else{currentIdx=(currentIdx-1+opts.length)%opts.length}opts[currentIdx].focus();return}
  }
  if(state.screen==="home"){if(key==="arrowdown"||key==="arrowup"){e.preventDefault();var cards=document.querySelectorAll(".theme-card");if(cards.length===0)return;var ci=-1;cards.forEach(function(c,i){if(c===document.activeElement)ci=i});if(key==="arrowdown"){ci=(ci+1)%cards.length}else{ci=(ci-1+cards.length)%cards.length}cards[ci].focus();return}}
  if(state.screen==="count-select"){if(key==="escape"){e.preventDefault();goHome();return}}
  if(state.screen==="results"){if(key==="enter"){var af=document.activeElement;if(!af||af===document.body){e.preventDefault();if(state.theme === "mix") openCountSelect();else openThemeCountSelect(state.theme);return}}if(key==="escape"){e.preventDefault();if(state.showReview){toggleReview()}else{goHome()}return}}
});

loadThemes();
</script>
</body>
</html>
